---
title: "Trabalho6"
author: "Thiago Tavares Lopes"
date: "2025-06-27"
output: html_document
---

```{r include=FALSE}
library(tidyverse)
library(VGAM)
library(MASS)
library(kableExtra)
library(knitr)
library(scales)  
library(ggtext)  
```


```{r, echo=FALSE}
dados <- tibble::tribble(
  ~tabaco, ~cardiaco, ~Excelente, ~Bom, ~Moderado, ~Ruim,
  "Sim",   "Sim",         27,     76,     101,      39,
  "Sim",   "Não",        402,    1050,    522,     145,
  "Não",   "Sim",         83,    406,     442,     114,
  "Não",   "Não",       1959,   4521,    2243,     405
)

dados_df <- as.data.frame(dados)

dados_p <- dados_df  |> 
  mutate(Total = Excelente + Bom + Moderado + Ruim) |>
  mutate(
    Excelente = Excelente / Total,
    Bom = Bom / Total,
    Moderado = Moderado / Total,
    Ruim = Ruim / Total
  ) |> 
  dplyr::select(-Total)  

dados_p$tabaco <- factor(dados_p$tabaco, levels = c("Sim", "Não"))
dados_p$cardiaco <- factor(dados_p$cardiaco, levels = c("Sim", "Não"), 
                           labels = c("Cardíaco", "Não Cardíaco"))

dados_melt <- dados_p |>
  pivot_longer(
    cols = c(Excelente, Bom, Moderado, Ruim),
    names_to = "Saude",
    values_to = "Proporcao"
  ) |>
  mutate(Saude = factor(Saude, 
                        levels = c("Ruim", "Moderado", "Bom", "Excelente"),
                        ordered = TRUE))

dados_cardiaco <- subset(dados_melt, cardiaco == "Cardíaco")
dados_nao_cardiaco <- subset(dados_melt, cardiaco == "Não Cardíaco")

plot_grafico <- function(dados) {
  ggplot(dados, aes(x = tabaco, y = Proporcao, fill = Saude)) +
    geom_bar(stat = "identity", position = position_dodge(preserve = "single")) +
    labs(
      x = "Tabagismo", 
      y = "Proporção", 
      fill = "Condição de Saúde",
      title = paste("Pacientes", unique(dados$cardiaco))
    ) +
    scale_fill_manual(values = c(
      "Ruim" = "#e7298a",
      "Moderado" = "#7570b3",
      "Bom" = "#d95f02",
      "Excelente" = "#1b9e77"
    )) +
    geom_text(
      aes(label = paste0(round(Proporcao * 100), "%")),
      position = position_dodge(width = 0.9),
      vjust = -0.5,
      size = 3
    ) +
    scale_y_continuous(limits = c(0, 0.7), expand = expansion(mult = c(0, 0.1))) +
    theme_minimal() +
    theme(
      legend.position = "right",
      panel.grid.major.x = element_blank(),
      plot.title = element_text(hjust = 0.5, face = "bold"),
      axis.title = element_text(face = "bold")
    )
}

plot_grafico(dados_cardiaco)
plot_grafico(dados_nao_cardiaco)

```




```{r, echo=FALSE}
dados1 <- dados |> 
  mutate(Total=rowSums(dados[,c(3:6)]))


dados1 |> 
  kbl() |> 
  kable_classic(full_width = F, html_font = "Cambria")




```


## Ajuste do modelo para Tabaco

Ajuste dos modelos para chances proporcionais (modelo mais simples) e para chances não proporcionais (modelo mais completo). 

No caso, temos que $H_{0}:\text{O modelo de chances proporcionais é o correto}$ \textit(arrumar esse termos aqui depois). 

```{r}
# Modelo Tabaco

# Modelo chances não proporcionais
mcnp <- vglm(cbind(Excelente,Bom,Moderado,Ruim) ~ tabaco,
             cumulative(parallel=FALSE,reverse=FALSE), dados)

# Modelo de chances proporcionais
mcp <- vglm(cbind(Excelente,Bom,Moderado,Ruim) ~ tabaco,
            cumulative(parallel=TRUE,reverse=FALSE), dados) 

round(coef(mcnp, matrix = TRUE), digits = 3)
round(coef(mcp, matrix = TRUE), digits = 3)

# Comparação dos modelos
# TRV <- 2*(logLik(mcnp) - logLik(mcp))
# gl <- length(coef(mcnp)) - length(coef(mcp))
# p <- 1-pchisq(TRV,gl)
# cbind(TRV, gl, p)

lrtest(mcnp, mcp)

```

No caso, para os ajuste do modelo para a variável tabaco:

- Modelo 1 (mais simples): assume efeito constante do tabaco para todas as transições (modelo de chances proporcionais, `parallel = TRUE`)

- Modelo 2 (mais complexo): permite que o efeito de tabaco varie entre as categorias (modelo de chances não proporcionais, `parallel = FALSE`)

Como o p-valor foi menor que 0.05, rejeitamos $H_{0}$, e podemos concluir que o modelo de chances proporcionais não é o modelo mais adequado. 


```{r}
# Modelos com somente CARDIACO

# Modelo chances não proporcionais
mcnp <- vglm(cbind(Excelente,Bom,Moderado,Ruim) ~ cardiaco,
             cumulative(parallel=FALSE,reverse=FALSE), dados)

# Modelo de chances proporcionais
mcp <- vglm(cbind(Excelente,Bom,Moderado,Ruim) ~ cardiaco,
            cumulative(parallel=TRUE,reverse=FALSE), dados) 

coef(mcnp, matrix = TRUE)
coef(mcp, matrix = TRUE)

# Comparação dos modelos
# TRV <- 2*(logLik(mcnp) - logLik(mcp))
# gl <- length(coef(mcnp)) - length(coef(mcp))
# p <- 1-pchisq(TRV,gl)
# cbind(TRV, gl, p)

lrtest(mcnp, mcp)
```


